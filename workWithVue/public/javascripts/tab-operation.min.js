define(["jquery","handlebars","system-config"],function(d,b,k){function c(){d(".navigation,.navigationTools").on("click","a",function(){var l=d(this).data("url"),q=d(this).text(),m=this.name,p=1;var n={tab_url:l,tab_text:q,tab_id:m};if(n.tab_url){d(".tab-block .tab-jump").each(function(){if(d(this).data("tab_id")==n.tab_id){p=0;return false}}).removeClass("tab-active");if(p){var o=b.compile(document.getElementById("tabTemplate").text);d(".tab-block").append(o(n));f()}else{d(".tab-block .tab-jump[data-tab_id="+n.tab_id+"]").addClass("tab-active")}}});d(".tab-block").on("click",".tab-jump",function(){var l=d(this).data("url"),m=d(this).data("tab_id");d(".tab-block .tab-jump").removeClass("tab-active");d(this).addClass("tab-active");if(l){d(".main-block iframe").hide();d(".main-block iframe[name=frame"+m+"]").show().css({left:50,opacity:0}).animate({left:0,opacity:1},500);if(k.myConfig.frameRefresh==1){h(m)}}}).on("click",".tab:not(.tab-active) .tab-close-container",function(){var l=d(this).parent().data("tab_id");d(".main-block .frame-created[name=frame"+l+"]").remove();d(this).parent().remove();return false}).on("click",".tab-active .tab-close-container",function(){var p=d(this).parent(),o=p.data("tab_id"),n=p.index(".tab-jump")-1,l=p.siblings(".tab-jump").eq(n),m=l.data("tab_id");p.remove();d(".main-block .frame-created[name=frame"+o+"]").remove();d(".main-block iframe[name=frame"+m+"]").show().css({left:50,opacity:0}).animate({left:0,opacity:1},500);l.addClass("tab-active");if(k.myConfig.frameRefresh==1){h(m)}return false}).on("dragstart",".tab-created",a).bind("dragover",e).bind("drop",j);d(".tabButton").on("click",".tabButton-tab-close",function(){d(".tab-close-menu").toggle(300);return false}).on("click","li",function(){d(".tab-close-menu").hide()}).on("mouseleave",function(){d(".tab-close-menu").hide()});d(".tabButton-close-all").click(function(){var l=d(".tab-block .tab_index");l.addClass("tab-active");d(".tab-block .tab-created").remove();d(".main-block .frame-created").remove();d(".main-block iframe").eq(0).show().css({left:50,opacity:0}).animate({left:0,opacity:1},500)});d(".tabButton-close-others").click(function(){var l=d(".tab-block .tab-active").data("tab_id");d(".tab-block .tab-created:not(.tab-active)").remove();d(".main-block .frame-created:not(:visible)").remove();if(k.myConfig.frameRefresh==1){h(l)}});d(".tabButton-refresh").click(function(){var l=d(".tab-block .tab-active").data("tab_id");h(l)})}function f(){while(true){var m=0,l=0;if(d(".left-block-container",parent.document).css("display")=="none"){m=d(".tab-block",parent.document).prop("clientWidth")-200}else{m=d(".tab-block",parent.document).prop("clientWidth")-400}d(".tab-block>.tab-created",parent.document).each(function(){l+=d(this).prop("clientWidth")});if(l>=m-100){d(".tab-block>.tab-created",parent.document).eq(0).remove()}else{break}}}function i(m,l){m.click(function(){if(l.url==""){throw new Error("您必须设置所要跳转页面的的URL")}var n=l.url,t=l.text||"新创建的标签",o=l.id||Math.floor(Math.random*1000),q=b.compile(d("#frameTemplate",parent.document).prop("text")),s=0;var p={tab_url:n,tab_text:t,tab_id:o};if(p.tab_url){d(".tab-block div",parent.document).each(function(){if(d(this).data("tab_id")==p.tab_id){s=1;return false}}).removeClass("tab-active");if(s){d(".tab-block div[data-tab_id="+p.tab_id+"]",parent.document).addClass("tab-active");d(".main-block iframe[name=frame"+p.tab_id+"]").show().css({left:50,opacity:0}).animate({left:0,opacity:1},500);if(k.myConfig.frameRefresh==1){h(p.tab_id)}}else{var r=b.compile(parent.document.getElementById("tabTemplate").text);d(".tab-block",parent.document).append(r(p));f(true);d(".main-block iframe",parent.document).hide();d(q({url:n,frame_id:p.tab_id})).css({left:50,opacity:0}).animate({left:0,opacity:1},500).appendTo(d(".main-block",parent.document))}}})}function e(){event.preventDefault();d(".tab").removeClass("tab-dragging")}function a(){var l=d(event.target);event.dataTransfer.setData("tab_id",l.data("tab_id"))}function j(){var l=event.dataTransfer.getData("tab_id"),m=d(".tab-created[data-tab_id="+l+"]"),n=g(m);if(n.afterOrBefore==0){m.insertBefore(n.$nearestTab)}else{m.insertAfter(n.$nearestTab)}}function g(q){var n=1,m=q,p=event.clientX,o=9999999999,l=d(".tab-block .tab-created");l.each(function(){var s=this,t=s.offsetLeft+s.offsetWidth/2,r=Math.abs(p-t);if(r<o){o=r;m=d(s);if(t>p){n=0}else{n=1}}});return{afterOrBefore:n,$nearestTab:m}}function h(l){parent.frames["frame"+l].location.reload()}return{initializeTabs:c,checkAndDeleteTabByLength:f,makeAButtonFrameAndTabMaker:i,refreshTheFrame:h}});